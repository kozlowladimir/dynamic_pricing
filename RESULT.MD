 <div class="ubertext">
              <p><strong>Отчет по практике “Алгоритмы динамического ценообразования в гостиницах”</strong></p>

<p>Важной задачей для любой компании является грамотное определение цены на товары и услуги в зависимости от параметров заказа, от текущей ситуации на складе, производстве, от наличия товара, сроков изготовления и доставки, а также от любых других параметров, которые могут влиять как на спрос, так и на предложение. Данная задача не обошла стороной и гостиничный бизнес. Для того чтобы получать максимальную прибыль необходимо всегда держать отель наполненным. На решение клиента поселиться именно в данной гостинице может влиять множество параметров. К таким параметрам относятся: наличие других гостиниц в окрестности; цены на номера в данной гостинице и в соседних; звездность отеля; сезон, качество оказываемых услуг и т.д. В свою очередь гостиница определяет цену за комнату в зависимости от своей загруженности, сезона, а также в зависимости от цен на номера гостиниц конкурентов и прочих параметров. </p>

<p>Естественно, что практически невозможно описать взаимодействие между клиентом и гостиницей во всех деталях в связи с чем для подбора оптимальной цены используются упрощенные модели поведения клиентов и упрощенные модели назначения цен в гостиницах. Автору работы было предложено ознакомиться с одной из таких моделей, оптимизировать скорость ее работы, а также реализовать алгоритмы по расчету оптимальный цены номера в гостинице.</p>

<p>Работа была разделена на три этапа:</p>

<ol>
<li>Ознакомиться с средой</li>
<li>Оптимизировать скорость работы</li>
<li>Написать алгоритм по формированию цены клиента</li>
</ol>

<p><strong>Ознакомление с средой</strong></p>

<p>Среда была передана в виде скрипта, написанного на языке python, и имплементировала базовое правило по назначению цены. В коде присутствовали следующие классы:</p>

<ul>
<li><strong>Hotel</strong>. Класс, описывающий состояние отеля, а именно количество и состояние комнат. Класс реализует следующие методы:

<ul>
<li>получить список номеров, удовлетворяющих заявке на бронирование</li>
<li>узнать загрузку отеля на определенный день</li>
<li>забронировать номер</li>
<li>посчитать выручку за текущий день</li>
</ul></li>
<li><strong>Request</strong>. Класс, описывающий параметры запроса на бронирования.</li>
<li><strong>EventGenerator</strong>. Класс, отвечающий за генерацию запросов. Класс описывает распределение продолжительности запроса, количества гостей, срока бронирования, количества запросов в день, распределения отмены бронирования. Так же класс реализует методы по генерации запросов на бронирование.</li>
<li><strong>AcceptanceRule</strong>. Класс, описывающий эластичность спроса по цене.</li>
<li><strong>PricingDefault</strong>. Класс, описывающий дефолтную стратегию ценообразования. В классе есть три важных параметра: Bar – номинальная цена номера; RackRate = 1.5 * Bar – максимально возможная цена номера; Netto = 0.5 * Bar – минимальная цена номера. Базовая стратегия назначения цены реализована в структуре данных “словарь” ключом которого является кортеж из текущего процента загрузки отеля на день заказа и глубины бронирования, а значением является скидка value в %. Итоговая цена определяется формулой price = RackRate - (RackRate - Netto) * value и реализована в методе set_price. 
Пример <code>default_strategy = {(100, 30): 0, (100, 28): 0, (100, 26): 0}</code></li>
</ul>

<p><strong>Алгоритм симуляции заявок, назначения цен и отказов:</strong></p>

<ol>
<li>Генерация заказов на предстоящий день. Количество заявок генерируется из распределения, заданного в EventGenerator</li>
<li>Для каждой из сгенерированных заявок

<ul>
<li>Проверка на наличие свободных комнат на день заказа в заявке</li>
<li>Назначение цены за комнату при наличии свободных мест</li>
<li>Генерация отмены заказов</li>
</ul></li>
<li>Подсчет общей прибыли за полный цикл (365 дней)</li>
</ol>

<p>Для ознакомления с базовым алгоритмом назначения цены был произведен ряд экспериментов, включающих в себя небольшие изменения базовой стратегии случайным образом путем увеличения или уменьшения цены на 5, 10, 15, 20 и 25 п.п. в каждом из экспериментов соответственно.</p>

<p>Параметрами эксперимента являлись: стратегия назначения цены P и математическое ожидание кол-ва заявок в день M. В каждом эксперименте проводилось по 100 симуляций, мат. ожидание кол-ва заявок в день равнялось 30. В процессе экспериментов замерялись следующие значения: математическое ожидание прибыли отеля R в у.е., стандартное отклонение прибыли отеля std_R в у.е, доля заполненных комнат в отеле L, стандартное отклонение доли заполненных комнат в отеле std_L. Результаты экспериментов приведены в таблице №1</p>

<table>
<thead>
<tr>
<th><br>P</th>
<th><br>R</th>
<th><br>Std R</th>
<th><br>L</th>
<th><br>Std L</th>
</tr>
</thead>

<tbody>
<tr>
<td><br>Базовая</td>
<td><br>1562746</td>
<td><br>26002</td>
<td><br>0.1536</td>
<td><br>0.0071</td>
</tr>
<tr>
<td><br>Базовая +- 5</td>
<td><br>1556012</td>
<td><br>23048</td>
<td><br>0.1553</td>
<td><br>0.0068</td>
</tr>
<tr>
<td><br>Базовая +- 10</td>
<td><br>1529065</td>
<td><br>23418</td>
<td><br>0.1522</td>
<td><br>0.0065</td>
</tr>
<tr>
<td><br>Базовая +- 15</td>
<td><br>1462150</td>
<td><br>20268</td>
<td><br>0.1492</td>
<td><br>0.0068</td>
</tr>
<tr>
<td><br>Базовая +- 20</td>
<td><br>1408753</td>
<td><br>20742</td>
<td><br>0.1756</td>
<td><br>0.0073</td>
</tr>
<tr>
<td><br>Базовая +- 25</td>
<td><br>1320908</td>
<td><br>19577</td>
<td><br>0.1785</td>
<td><br>0.0065</td>
</tr>
<tr>
<td><br>Рандомная цена по сетке</td>
<td><br>1158829</td>
<td><br>26881</td>
<td><br>0.2006</td>
<td><br>0.0094</td>
</tr>
<tr>
<td><br>Рандомная цена по сетке v2</td>
<td><br>1158486</td>
<td><br>23464</td>
<td><br>0.2042</td>
<td><br>0.0093</td>
</tr>
<tr>
<td><br>Рандомная цена</td>
<td><br>1183169</td>
<td><br>20356</td>
<td><br>0.1647</td>
<td><br>0.0075</td>
</tr>
</tbody>
</table>

<p>Таблица №1. Результаты исследования базовой стратегии назначения цены.</p>

<p>Из таблицы можно заметить, что базовый алгоритм устойчив к изменению цены на +- 5%. Дальнейшие изменения цены ведут к уменьшению прибыли. При этом базовый алгоритм лучше рандомного назначения цены в 1.3 раза при том, что доля свободных мест в отеле почти не отличается.</p>

<p><strong>Оптимизация скорости работы</strong></p>

<p>В процессе изучения среды и базовой стратегии назначения цены было замерено время симуляции. В среднем на один цикл из 100 симуляций тратилось 20 минут на google colab. Очевидно, что увеличение мат. ожидания заявок, усложнение стратегии назначения цены или введение алгоритма обучения назначения цены привело бы к увеличению времени работы, что могло бы сказаться на количестве проведенных экспериментов в связи с чем был предпринят анализ возможных путей оптимизации кода. В результате анализа возникло несколько шагов по увеличению скорости работы, а именно:</p>

<ol>
<li>Векторизовать все независимые друг от друга вычисления. Ожидаемый прирост скорости неизвестен</li>
<li>Распараллелить симуляции по тредам. Ожидаемый прирост скорости равен количеству потоков.</li>
</ol>

<p>Для ускорения работы кода было переделано несколько методов в классах EventGenerator и AcceptanceRule, что позволило ускорить вычисления в 5 раз. Для нахождения узких мест в коде использовал библиотеку line_profiler. Пример работы библиотеки</p>

<pre><code>Line # Hits Time Per Hit % Time Line Contents
==============================================================
    23 def decision(self, price):
    24 &quot;&quot;&quot;
    25 Принятие решения о бронировании при указанной цене
    26 :param price: цена
    27 :return: забронировали или нет
    28 &quot;&quot;&quot;
    29 1 423.0 423.0 80.7 acceptance_chance = 1 - norm.cdf(self.rho * (price / self.nominal_price - 1))
    30 # return bernoulli(acceptance_chance).rvs()
    31 1 101.0 101.0 19.3 return np.random.choice([0, 1], p=[1-acceptance_chance, acceptance_chance])
</code></pre>

<p>Распараллеливание не рассматривалось т.к. под рукой находился компьютер с одним ядром.</p>

<p><strong>Алгоритм по формированию цены клиента</strong></p>

<p>В результате работы был реализовал алгоритм, основанный на обучении с подкреплением. Фактически был произведен расчёт принятия той или иной цены клиентов и последующее назначение цены с учетом кол-ва свободных мест в отеле. Анализировалось 41 значение цены в диапазоне от Netto до RackRate с одинаковым шагом.
Результирующий алгоритм назначения цены описан ниже:</p>

<ol>
<li>Первые 500 заказов раздаю цену в случайном порядке.</li>
<li>Считается кол-во свободных номеров N на дату заказа. Если все занято, то назначается максимальная цена.</li>
<li>Определяется какое количество запросов Q еще поступит на данную дату.</li>
<li>Вычисляется отношение Q к N. Назовем это requests_per_room. Фактически оценивается сколько еще запросов придет на одну комнату в заданный день</li>
<li>Считается % принятия цены, а также доверительный интервал с учетом кол-ва показов цены. Назовем это acceptance_rate</li>
<li>acceptance_rate умножается на requests_per_room и выбирается такая цена при которой произведение &gt;= 1 и меньше всех остальных. Значение 1 является параметров алгоритма и с помощью его изменения можно оптимизировать прибыль</li>
</ol>

<p>Данный алгоритм был исследован при различных параметрах. Результаты исследования приведены в таблице №2.</p>

<table>
<thead>
<tr>
<th>Threshold</th>
<th>R</th>
<th>std R</th>
<th>L</th>
<th>std L</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>1512539</td>
<td>32910</td>
<td>0,16</td>
<td>0,016</td>
</tr>
<tr>
<td>1,2</td>
<td>1524075</td>
<td>27796</td>
<td>0,15</td>
<td>0,008</td>
</tr>
<tr>
<td>1,4</td>
<td>1527353</td>
<td>33843</td>
<td>0,14</td>
<td>0,0068</td>
</tr>
<tr>
<td>1,6</td>
<td>1525508</td>
<td>27979</td>
<td>0,14</td>
<td>0,0067</td>
</tr>
<tr>
<td>1,8</td>
<td>1528210</td>
<td>27623</td>
<td>0,14</td>
<td>0,0059</td>
</tr>
<tr>
<td>2</td>
<td>1523107</td>
<td>25755</td>
<td>0,14</td>
<td>0,0055</td>
</tr>
<tr>
<td>2,2</td>
<td>1517553</td>
<td>30412</td>
<td>0,14</td>
<td>0,0057</td>
</tr>
<tr>
<td>2,4</td>
<td>1511019</td>
<td>24893</td>
<td>0,14</td>
<td>0,0058</td>
</tr>
<tr>
<td>2,6</td>
<td>1508139</td>
<td>29579</td>
<td>0,14</td>
<td>0,0059</td>
</tr>
<tr>
<td>2,8</td>
<td>1496910</td>
<td>29048</td>
<td>0,14</td>
<td>0,006</td>
</tr>
<tr>
<td>3</td>
<td>1489928</td>
<td>29200</td>
<td>0,14</td>
<td>0,0053</td>
</tr>
<tr>
<td>3,2</td>
<td>1489798</td>
<td>30798</td>
<td>0,14</td>
<td>0,0066</td>
</tr>
<tr>
<td>3,4</td>
<td>1487056</td>
<td>31123</td>
<td>0,14</td>
<td>0,0056</td>
</tr>
<tr>
<td>3,6</td>
<td>1471654</td>
<td>30666</td>
<td>0,14</td>
<td>0,0059</td>
</tr>
<tr>
<td>3,8</td>
<td>1475464</td>
<td>30703</td>
<td>0,14</td>
<td>0,0062</td>
</tr>
<tr>
<td>4</td>
<td>1473107</td>
<td>27086</td>
<td>0,14</td>
<td>0,0067</td>
</tr>
</tbody>
</table>

<p>Таблица №2. Результаты исследования алгоритма поиска оптимальной стратегии назначения цены.</p>

<p>Видно, что максимальное значение прибыли достигается в диапазоне порога от 1.2 до 2. На текущий момент ценовая стратегия, полученная за счет онлайн обучения оказалась хуже базовой стратегии.</p>

<p><strong>Дальнейшие планы:</strong></p>

<ol>
<li>Реализовать алгоритм по подбору оптимальной ценовой стратегии на основе базовой стратегии, а именно искать оптимальные параметры посредством небольшого изменения цены.</li>
<li>Сравнить время нахождения оптимальной ценовой политики различными алгоритмами.</li>
<li><p>Использовать ценовую политики, полученную в процессе онлайн обучения, вместо базовой ценовой политики. Расчет на то, что если начинать обучение не с холодного старта, то результаты будут лучше</p></li>
<li><p>Выложить наработки в git</p></li>
<li><p>Формализовать задачу и свести к динамическому программированию (под вопросом)</p></li>
</ol>